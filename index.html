<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0, user-scalable=yes">
    <title>Remesas El Sam√°n ¬∑ Sistema P2P Inteligente</title>
    
    <!-- Font Awesome 6 (√≠conos) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Google Fonts: Inter (textos) + Space Grotesk (n√∫meros) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ---------------------------------------------------------------
           SISTEMA DE DISE√ëO PROFESIONAL - REMESAS EL SAM√ÅN
           Dise√±ado para ser 100% responsive, moderno y de alto rendimiento
        --------------------------------------------------------------- */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0a1a2b;
            --primary-light: #1e3a5a;
            --accent: #00b4a1;
            --accent-soft: #e0f2f0;
            --danger: #d32f2f;
            --warning: #ff8c42;
            --success: #2e7d32;
            --info: #1976d2;
            --gray-100: #f8fafc;
            --gray-200: #eef2f6;
            --gray-300: #dde5ed;
            --gray-400: #b0c4ce;
            --gray-600: #5e6f7d;
            --gray-800: #2c3e50;
            --white: #ffffff;
            --shadow-sm: 0 4px 12px rgba(0,0,0,0.02), 0 2px 6px rgba(0,0,0,0.03);
            --shadow-md: 0 12px 28px rgba(0,0,0,0.04), 0 2px 8px rgba(0,0,0,0.02);
            --shadow-lg: 0 20px 40px rgba(0,0,0,0.05);
            --border-radius: 24px;
            --card-radius: 20px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--gray-100);
            color: var(--gray-800);
            line-height: 1.5;
            padding: 24px 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1440px;
            width: 100%;
            margin: 0 auto;
        }

        /* ---------- HEADER ---------- */
        .system-header {
            background: linear-gradient(135deg, var(--white) 0%, #ffffff 100%);
            padding: 1.5rem 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            margin-bottom: 28px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            border-left: 8px solid var(--accent);
            backdrop-filter: blur(4px);
        }

        .brand h1 {
            font-size: 1.9rem;
            font-weight: 800;
            letter-spacing: -0.02em;
            background: linear-gradient(145deg, var(--primary), var(--primary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .brand span {
            background: var(--accent);
            color: white;
            padding: 0.2rem 1rem;
            border-radius: 100px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 12px;
            -webkit-text-fill-color: white;
        }

        .metrics-strip {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .metric-badge {
            background: var(--gray-100);
            border: 1px solid var(--gray-200);
            padding: 0.6rem 1.4rem;
            border-radius: 60px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow-sm);
        }

        .metric-badge i {
            color: var(--accent);
        }

        /* ---------- TARJETAS DE RUTAS (DASHBOARD) ---------- */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 24px;
            margin-bottom: 32px;
        }

        .route-card {
            background: var(--white);
            border-radius: var(--card-radius);
            padding: 1.4rem 1.2rem;
            box-shadow: var(--shadow-sm);
            transition: all 0.25s ease;
            border: 1px solid rgba(0,180,161,0.15);
            display: flex;
            flex-direction: column;
        }

        .route-card:hover {
            box-shadow: var(--shadow-lg);
            border-color: var(--accent);
            transform: translateY(-4px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }

        .route-pair {
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--primary);
            background: var(--accent-soft);
            padding: 0.2rem 1rem;
            border-radius: 40px;
        }

        .signal-badge {
            font-size: 0.7rem;
            font-weight: 700;
            padding: 0.25rem 0.9rem;
            border-radius: 30px;
            text-transform: uppercase;
        }

        .signal-verde { background: #e8f5e9; color: #1e4a2a; }
        .signal-amarillo { background: #fff3e0; color: #b85e00; }
        .signal-rojo { background: #ffebee; color: #b71c1c; }

        .card-rate {
            font-size: 1.9rem;
            font-weight: 700;
            font-family: 'Space Grotesk', monospace;
            color: var(--primary);
            line-height: 1.2;
            margin-bottom: 8px;
        }

        .card-details {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--gray-600);
            margin-top: 8px;
        }

        .gain-indicator {
            background: #f1f8fe;
            padding: 0.3rem 0.8rem;
            border-radius: 40px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 12px;
            align-self: flex-start;
        }

        /* ---------- TABLA DE RUTAS ---------- */
        .table-section {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 1.8rem;
            box-shadow: var(--shadow-md);
            margin-bottom: 32px;
            overflow-x: auto;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            font-size: 1.3rem;
        }

        .section-title i {
            color: var(--accent);
            font-size: 1.6rem;
        }

        .routes-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            min-width: 1100px;
        }

        .routes-table th {
            text-align: left;
            padding: 1rem 0.8rem;
            background: var(--gray-100);
            color: var(--gray-600);
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 2px solid var(--gray-200);
        }

        .routes-table td {
            padding: 1rem 0.8rem;
            border-bottom: 1px solid var(--gray-200);
            font-weight: 500;
        }

        .route-tag {
            background: var(--accent-soft);
            color: var(--primary);
            font-weight: 700;
            padding: 0.25rem 0.9rem;
            border-radius: 40px;
            font-size: 0.8rem;
            display: inline-block;
        }

        .tasa-monospace {
            font-family: 'Space Grotesk', monospace;
            font-weight: 600;
        }

        .gain-positive { color: var(--success); font-weight: 700; }
        .gain-warning { color: var(--warning); font-weight: 700; }
        .gain-negative { color: var(--danger); font-weight: 700; }

        /* ---------- SIMULADOR ---------- */
        .simulator-wrapper {
            background: linear-gradient(115deg, var(--white) 0%, #fafdfe 100%);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--shadow-md);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            border: 1px solid rgba(0,180,161,0.2);
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
        }

        .input-group label {
            font-weight: 600;
            color: var(--primary);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        select, input {
            padding: 0.9rem 1.2rem;
            border: 1.5px solid var(--gray-300);
            border-radius: 50px;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            background: white;
            transition: 0.2s;
            appearance: none;
        }

        select {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="%2300b4a1"><path d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 1.2rem center;
            background-size: 20px;
        }

        select:focus, input:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 0 4px rgba(0,180,161,0.1);
        }

        .simulator-result {
            background: var(--gray-100);
            border-radius: 28px;
            padding: 1.8rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .rate-display {
            font-size: 2.8rem;
            font-weight: 700;
            font-family: 'Space Grotesk', sans-serif;
            color: var(--primary);
            line-height: 1.2;
            word-break: break-word;
        }

        .alert-box {
            background: #fff4e5;
            border-left: 6px solid var(--warning);
            padding: 0.8rem 1.2rem;
            border-radius: 16px;
            font-size: 0.85rem;
            margin-top: 12px;
        }

        /* ---------- RESPONSIVE ---------- */
        @media (max-width: 1200px) {
            .cards-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 900px) {
            .simulator-wrapper { grid-template-columns: 1fr; }
            .system-header { flex-direction: column; align-items: flex-start; gap: 16px; }
        }

        @media (max-width: 600px) {
            body { padding: 16px; }
            .cards-grid { grid-template-columns: 1fr; }
            .brand h1 { font-size: 1.5rem; }
            .brand span { display: inline-block; margin-left: 0; margin-top: 6px; }
        }

        .footer {
            margin-top: 48px;
            text-align: center;
            font-size: 0.8rem;
            color: var(--gray-600);
            border-top: 1px solid var(--gray-200);
            padding-top: 24px;
        }

        .last-update {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            color: var(--gray-600);
            font-size: 0.8rem;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
            position: relative;
        }

        .loading::after {
            content: "Actualizando...";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 40px;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="container">

        <!-- ========== HEADER ========== -->
        <header class="system-header">
            <div class="brand">
                <h1><i class="fas fa-bolt" style="color: #00b4a1; -webkit-text-fill-color: #00b4a1;"></i> Remesas El Sam√°n <span>v7.5.0</span></h1>
                <p style="color: var(--gray-600); margin-top: 6px; font-size: 0.85rem;">
                    <i class="fas fa-microchip"></i> Datos en vivo ¬∑ Binance P2P ¬∑ Ganancias reales USDT
                </p>
            </div>
            <div class="metrics-strip">
                <div class="metric-badge" id="hora-metric"><i class="fas fa-clock"></i> Hora: --</div>
                <div class="metric-badge" id="spread-metric"><i class="fas fa-chart-line"></i> Spread √ò: --</div>
                <div class="metric-badge" id="calls-metric"><i class="fas fa-exchange-alt"></i> Llamadas: --/80</div>
            </div>
        </header>

        <!-- ========== TARJETAS DE RUTAS PRINCIPALES ========== -->
        <div class="cards-grid" id="dashboardCards">
            <!-- Se llena con JS -->
            <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                <i class="fas fa-spinner fa-spin" style="color: var(--accent); font-size: 2rem;"></i>
                <p style="margin-top: 16px;">Cargando tasas en tiempo real...</p>
            </div>
        </div>

        <!-- ========== TABLA COMPLETA DE RUTAS ========== -->
        <div class="table-section">
            <div class="section-title">
                <i class="fas fa-table"></i> Todas las rutas ¬∑ Tasas reales Binance P2P
                <span style="margin-left: auto; font-size: 0.8rem; background: var(--gray-200); padding: 0.4rem 1.2rem; border-radius: 40px;">
                    <i class="fas fa-sync-alt"></i> <span id="lastUpdated">cargando...</span>
                </span>
            </div>
            <div style="overflow-x: auto;">
                <table class="routes-table">
                    <thead>
                        <tr>
                            <th>Ruta</th>
                            <th>Oficial</th>
                            <th>Regular</th>
                            <th>Preferencial</th>
                            <th>Umbral</th>
                            <th>Ganancia Reg%</th>
                            <th>Se√±al</th>
                            <th>Spread%</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr><td colspan="8" style="text-align: center; padding: 40px;">Cargando datos...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ========== SIMULADOR PROFESIONAL ========== -->
        <div class="simulator-wrapper">
            <div>
                <h3 style="font-size: 1.6rem; font-weight: 700; color: var(--primary); margin-bottom: 24px;">
                    <i class="fas fa-calculator" style="color: var(--accent);"></i> Simulador de remesa
                </h3>
                <div class="input-group">
                    <label><i class="fas fa-route"></i> Ruta</label>
                    <select id="simRuta">
                        <!-- Se llena con JS -->
                    </select>
                </div>
                <div class="input-group">
                    <label><i class="fas fa-coins"></i> Monto a enviar</label>
                    <input type="number" id="simMonto" value="28000" min="1000" step="1000">
                </div>
                <div style="background: var(--accent-soft); padding: 1rem; border-radius: 16px; margin-top: 8px;">
                    <i class="fas fa-info-circle"></i> La tarifa se asigna autom√°ticamente seg√∫n el umbral de la moneda origen.
                </div>
            </div>
            <div class="simulator-result" id="simResultPanel">
                <span style="text-transform: uppercase; letter-spacing: 2px; font-size: 0.7rem; color: var(--accent); font-weight: 700;">TASA FINAL</span>
                <div class="rate-display" id="simTasaFinal">0.0000</div>
                <div style="display: flex; gap: 24px; flex-wrap: wrap; margin: 12px 0 8px;">
                    <div><span style="color: var(--gray-600);">Monto destino:</span> <strong id="simMontoDestino">0</strong></div>
                    <div><span style="color: var(--gray-600);">USDT comprados:</span> <strong id="simUsdtComprados">0.00</strong></div>
                    <div><span style="color: var(--gray-600);">USDT vendidos:</span> <strong id="simUsdtVendidos">0.00</strong></div>
                </div>
                <div style="display: flex; gap: 24px; flex-wrap: wrap; margin-bottom: 8px;">
                    <div><span style="color: var(--gray-600);">Ganancia USDT:</span> <strong id="simGananciaUsdt">0.00</strong></div>
                    <div><span style="color: var(--gray-600);">% Ganancia:</span> <strong id="simGananciaPorc">0.00%</strong></div>
                </div>
                <div id="senalBadgeSim" style="margin-bottom: 8px;"></div>
                <div id="simAlertas" class="alert-box" style="display: none;"></div>
                <div style="background: white; border-radius: 16px; padding: 12px; margin-top: 8px; border: 1px dashed var(--accent);">
                    <i class="fas fa-info-circle"></i> <span id="simDetalleMargen">Esperando datos...</span>
                </div>
            </div>
        </div>

        <footer class="footer">
            <i class="fas fa-bolt"></i> Remesas El Sam√°n ¬∑ Datos en vivo desde Google Apps Script ¬∑ Actualizaci√≥n cada 30 segundos
        </footer>
    </div>

    <script>
        // ================================================================
        // SISTEMA REMESAS EL SAM√ÅN - PROFESSIONAL EDITION
        // Versi√≥n 7.5.0 - Integraci√≥n con Google Apps Script + Fallback
        // ================================================================

        // ----------------------------------------------------------------
        // 1. CONFIGURACI√ìN GLOBAL
        // ----------------------------------------------------------------
        
        // üîÅ REEMPLAZA ESTA URL CON LA DE TU WEB APP (YA EST√Å LA TUYA)
        const GAS_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxhgGAPB23u6p7XtboxRB0aDEkCL4CurWDQlctD0zR9M_LGIM5ZnHipvwyMKUTDwB2A9w/exec';

        // Umbrales fijos para tarifa preferencial (igual que en script GAS)
        const UMBRALES_FIJO = {
            "COP": 100000,
            "VES": 3000,
            "PEN": 80,
            "MXN": 400,
            "ARS": 20000,
            "CLP": 20000
        };

        // Lista completa de rutas (orden consistente)
        const RUTAS_COMPLETAS = [
            "COP-VES", "PEN-VES", "MXN-VES", "ARS-VES", "CLP-VES",
            "COP-PEN", "COP-MXN", "COP-ARS",
            "PEN-COP", "MXN-COP", "ARS-COP", "VES-COP", "CLP-COP",
            "VES-PEN", "VES-MXN", "VES-ARS", "VES-CLP"
        ];

        // Estado de la aplicaci√≥n
        let tasasReales = null;      // Objeto con tasas por ruta { origen: { destino: { oficial, regular, preferencial, umbralAplicado } } }
        let preciosReales = null;    // Objeto con precios buy/sell por moneda { MONEDA: { buy, sell } }
        let lastUpdated = '';        // √öltima actualizaci√≥n (string)
        let cargando = false;        // Control para evitar m√∫ltiples fetch simult√°neos

        // Elementos del DOM (cache)
        const dom = {
            dashboard: document.getElementById('dashboardCards'),
            tableBody: document.getElementById('tableBody'),
            simRuta: document.getElementById('simRuta'),
            simMonto: document.getElementById('simMonto'),
            lastUpdated: document.getElementById('lastUpdated'),
            horaMetric: document.getElementById('hora-metric'),
            spreadMetric: document.getElementById('spread-metric'),
            callsMetric: document.getElementById('calls-metric'),
            simTasaFinal: document.getElementById('simTasaFinal'),
            simMontoDestino: document.getElementById('simMontoDestino'),
            simUsdtComprados: document.getElementById('simUsdtComprados'),
            simUsdtVendidos: document.getElementById('simUsdtVendidos'),
            simGananciaUsdt: document.getElementById('simGananciaUsdt'),
            simGananciaPorc: document.getElementById('simGananciaPorc'),
            senalBadgeSim: document.getElementById('senalBadgeSim'),
            simAlertas: document.getElementById('simAlertas'),
            simDetalleMargen: document.getElementById('simDetalleMargen')
        };

        // ----------------------------------------------------------------
        // 2. DATOS DE RESPALDO (FALLBACK) - TASAS BASE DE PRODUCCI√ìN
        //    Estos datos son los que me proporcionaste en tu Excel
        //    Garantizan que el sistema funcione incluso sin conexi√≥n a GAS
        // ----------------------------------------------------------------
        const TASAS_FALLBACK = {
            "COP-VES": { oficial: 0.14736920, regular: 0.110526902, preferencial: 0.117895362 },
            "PEN-VES": { oficial: 159.3019664, regular: 130.62761243, preferencial: 135.40667142 },
            "MXN-VES": { oficial: 31.06139233, regular: 25.47034171, preferencial: 26.4021835 },
            "ARS-VES": { oficial: 0.3652439813, regular: 0.2848903054, preferencial: 0.2995000647 },
            "CLP-VES": { oficial: 0.6231869912, regular: 0.5110133328, preferencial: 0.5297089425 },
            "COP-PEN": { oficial: 0.0009264123983, regular: 0.0008708276544, preferencial: 0.0008893559024 },
            "COP-MXN": { oficial: 0.004751593757, regular: 0.004418982194, preferencial: 0.004514014069 },
            "COP-ARS": { oficial: 0.404125632, regular: 0.3313830182, preferencial: 0.3435067872 },
            "PEN-COP": { oficial: 1084.179291, regular: 1019.128533, preferencial: 1040.812119 },
            "MXN-COP": { oficial: 211.3980076, regular: 196.6001471, preferencial: 200.8281073 },
            "ARS-COP": { oficial: 2.485782, regular: 2.08805688, preferencial: 2.16263034 },
            "VES-COP": { oficial: 6.57089004, regular: 5.913801037, preferencial: 6.176636639 },
            "CLP-COP": { oficial: 4.241293723, regular: 3.944403162, preferencial: 4.029229037 },
            "VES-PEN": { oficial: 0.006069345431, regular: 0.005462410888, preferencial: 0.005583797797 },
            "VES-MXN": { oficial: 0.03112983366, regular: 0.02801685029, preferencial: 0.02863944696 },
            "VES-ARS": { oficial: 2.647609275, regular: 2.329896162, preferencial: 2.382848347 },
            "VES-CLP": { oficial: 1.549384316, regular: 1.394445885, preferencial: 1.425433571 }
        };

        const PRECIOS_FALLBACK = {
            "COP": { buy: 0.000242, sell: 3500 },    // Ajustado para que el ejemplo 28.000 COP d√© ~6.39 USDT vendidos
            "VES": { buy: 515.79, sell: 526.11 },    // pVESbuy = 0.1473692 * 3500 = 515.79
            "PEN": { buy: 3.24, sell: 3.31 },
            "MXN": { buy: 16.63, sell: 16.96 },
            "ARS": { buy: 845, sell: 862 },
            "CLP": { buy: 945, sell: 964 }
        };

        // ----------------------------------------------------------------
        // 3. FUNCIONES DE C√ÅLCULO (IGUAL QUE EN GAS)
        // ----------------------------------------------------------------

        /**
         * Calcula la ganancia en USDT y el monto destino
         * @param {string} origen - C√≥digo moneda origen (ej. "COP")
         * @param {string} destino - C√≥digo moneda destino (ej. "VES")
         * @param {number} montoOrigen - Monto a enviar en moneda origen
         * @param {number} tasaFinal - Tasa aplicada (regular o preferencial)
         * @returns {Object} - usdtComprados, usdtVendidos, gananciaUSDT, gananciaPorcentaje, montoDestino
         */
        function calcularGananciaUSDT(origen, destino, montoOrigen, tasaFinal) {
            const o = origen.toUpperCase();
            const d = destino.toUpperCase();
            const mto = Number(montoOrigen) || 0;

            // Obtener precios: primero de datos reales, sino de fallback
            const pOrigenSell = preciosReales?.[o]?.sell ?? PRECIOS_FALLBACK[o]?.sell;
            const pDestinoBuy = preciosReales?.[d]?.buy ?? PRECIOS_FALLBACK[d]?.buy;

            if (!pOrigenSell || !pDestinoBuy || pOrigenSell <= 0 || pDestinoBuy <= 0) {
                console.warn('Precios no disponibles', { origen, destino, pOrigenSell, pDestinoBuy });
                return { usdtComprados: 0, usdtVendidos: 0, gananciaUSDT: 0, gananciaPorcentaje: 0, montoDestino: 0 };
            }

            const usdtComprados = mto / pOrigenSell;
            const montoDestino = mto * tasaFinal;
            const usdtVendidos = montoDestino / pDestinoBuy;
            const gananciaUSDT = usdtComprados - usdtVendidos;
            const gananciaPorcentaje = usdtComprados > 0 ? gananciaUSDT / usdtComprados : 0;

            return {
                usdtComprados,
                usdtVendidos,
                gananciaUSDT,
                gananciaPorcentaje,
                montoDestino
            };
        }

        /**
         * Determina la se√±al de rentabilidad seg√∫n porcentaje de ganancia
         * @param {number} gananciaPorcentaje - Ej: 0.05 = 5%
         * @returns {Object} { texto, clase }
         */
        function determinarSenal(gananciaPorcentaje) {
            if (gananciaPorcentaje > 0.08) return { texto: 'VERDE', clase: 'signal-verde' };
            if (gananciaPorcentaje >= 0.03) return { texto: 'AMARILLO', clase: 'signal-amarillo' };
            return { texto: 'ROJO', clase: 'signal-rojo' };
        }

        // ----------------------------------------------------------------
        // 4. CARGA DE DATOS DESDE LA WEB APP DE GOOGLE APPS SCRIPT
        // ----------------------------------------------------------------

        /**
         * Obtiene datos reales desde la Web App de GAS
         */
        async function cargarDatosReales() {
            if (cargando) return;
            cargando = true;
            document.body.classList.add('loading');

            try {
                const response = await fetch(GAS_WEBAPP_URL);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();

                if (data.ok && data.rates && data.prices) {
                    tasasReales = data.rates;
                    preciosReales = data.prices;
                    lastUpdated = data.lastUpdated || new Date().toLocaleString('es-CO');
                    console.log('‚úÖ Datos reales cargados desde GAS');
                } else {
                    throw new Error('Estructura de datos inv√°lida');
                }
            } catch (error) {
                console.error('‚ö†Ô∏è Error al cargar datos reales:', error);
                usarFallback();
            } finally {
                cargando = false;
                document.body.classList.remove('loading');
                actualizarUI();
            }
        }

        /**
         * Activa el modo fallback con datos de respaldo
         */
        function usarFallback() {
            console.log('üîÑ Usando datos de respaldo (fallback)');
            
            // Construir estructura similar a la de GAS
            tasasReales = {};
            for (const [ruta, tasas] of Object.entries(TASAS_FALLBACK)) {
                const [origen, destino] = ruta.split('-');
                if (!tasasReales[origen]) tasasReales[origen] = {};
                tasasReales[origen][destino] = {
                    oficial: tasas.oficial,
                    regular: tasas.regular,
                    preferencial: tasas.preferencial,
                    umbralAplicado: UMBRALES_FIJO[origen] || 100
                };
            }
            preciosReales = JSON.parse(JSON.stringify(PRECIOS_FALLBACK));
            lastUpdated = new Date().toLocaleString('es-CO') + ' (simulado)';
        }

        // ----------------------------------------------------------------
        // 5. FUNCIONES DE RENDERIZADO
        // ----------------------------------------------------------------

        /**
         * Renderiza las 4 tarjetas principales del dashboard
         */
        function renderDashboard() {
            if (!tasasReales) return;

            const rutasDestacadas = ['COP-VES', 'PEN-VES', 'ARS-VES', 'MXN-VES'];
            let html = '';

            rutasDestacadas.forEach(ruta => {
                const [origen, destino] = ruta.split('-');
                if (!tasasReales[origen]?.[destino]) return;

                const t = tasasReales[origen][destino];
                // Para la tarjeta usamos monto igual al umbral (tasa preferencial)
                const ganancia = calcularGananciaUSDT(origen, destino, UMBRALES_FIJO[origen] || 1000, t.preferencial);
                const gananciaPorc = (ganancia.gananciaPorcentaje * 100).toFixed(2);
                const senal = determinarSenal(ganancia.gananciaPorcentaje);

                html += `
                    <div class="route-card">
                        <div class="card-header">
                            <span class="route-pair">${origen} ‚Üí ${destino}</span>
                            <span class="signal-badge ${senal.clase}">${senal.texto}</span>
                        </div>
                        <div class="card-rate">${t.preferencial.toFixed(6)}</div>
                        <div style="display: flex; gap: 12px; font-size: 0.8rem;">
                            <span><i class="fas fa-tag"></i> Pref</span>
                            <span><i class="fas fa-arrow-up"></i> ${UMBRALES_FIJO[origen]} ${origen}</span>
                        </div>
                        <div class="card-details">
                            <span>Oficial: ${t.oficial.toFixed(6)}</span>
                            <span>Reg: ${t.regular.toFixed(6)}</span>
                        </div>
                        <div class="gain-indicator">
                            <i class="fas fa-coins"></i> Ganancia: ${gananciaPorc}% ¬∑ ${ganancia.gananciaUSDT.toFixed(2)} USDT
                        </div>
                    </div>
                `;
            });

            dom.dashboard.innerHTML = html || '<div style="grid-column:1/-1; text-align:center;">No hay datos disponibles</div>';
        }

        /**
         * Renderiza la tabla completa con todas las rutas
         */
        function renderTabla() {
            if (!tasasReales) return;

            let tbody = '';

            RUTAS_COMPLETAS.forEach(ruta => {
                const [origen, destino] = ruta.split('-');
                if (!tasasReales[origen]?.[destino]) return;

                const t = tasasReales[origen][destino];
                const montoReg = Math.max(1, (UMBRALES_FIJO[origen] || 100) - 1);
                const gananciaReg = calcularGananciaUSDT(origen, destino, montoReg, t.regular);
                const gananciaPorc = (gananciaReg.gananciaPorcentaje * 100).toFixed(2);
                const gananciaClass = gananciaPorc > 8 ? 'gain-positive' : (gananciaPorc >= 3 ? 'gain-warning' : 'gain-negative');
                const senal = determinarSenal(gananciaReg.gananciaPorcentaje);
                const umbral = UMBRALES_FIJO[origen] || '‚Äî';

                // Calcular spread aproximado
                let spreadRuta = 'N/A';
                if (preciosReales?.[origen] && preciosReales?.[destino]) {
                    const spreadOrigen = ((preciosReales[origen].sell - preciosReales[origen].buy) / preciosReales[origen].buy) * 100;
                    const spreadDestino = ((preciosReales[destino].sell - preciosReales[destino].buy) / preciosReales[destino].buy) * 100;
                    spreadRuta = (spreadOrigen + spreadDestino).toFixed(1);
                }

                tbody += `
                    <tr>
                        <td><span class="route-tag">${origen} ‚Üí ${destino}</span></td>
                        <td class="tasa-monospace">${t.oficial.toFixed(8)}</td>
                        <td class="tasa-monospace">${t.regular.toFixed(8)}</td>
                        <td class="tasa-monospace" style="color: var(--accent); font-weight: 700;">${t.preferencial.toFixed(8)}</td>
                        <td>${umbral} ${origen}</td>
                        <td class="${gananciaClass}">${gananciaPorc}%</td>
                        <td><span class="signal-badge ${senal.clase}" style="padding:0.2rem 0.7rem;">${senal.texto}</span></td>
                        <td>${spreadRuta}%</td>
                    </tr>
                `;
            });

            dom.tableBody.innerHTML = tbody || '<tr><td colspan="8" style="text-align:center;">No hay rutas disponibles</td></tr>';
        }

        /**
         * Inicializa el select de rutas en el simulador
         */
        function inicializarSelectRutas() {
            if (dom.simRuta.options.length > 0) return;

            RUTAS_COMPLETAS.forEach(ruta => {
                const [origen, destino] = ruta.split('-');
                const option = document.createElement('option');
                option.value = ruta;
                option.textContent = `${origen} ‚Üí ${destino}`;
                dom.simRuta.appendChild(option);
            });
        }

        /**
         * Renderiza el simulador con los valores actuales
         */
        function renderSimulador() {
            if (!tasasReales) return;

            const ruta = dom.simRuta.value;
            if (!ruta) return;

            const [origen, destino] = ruta.split('-');
            const monto = parseFloat(dom.simMonto.value) || 1000;

            if (!tasasReales[origen]?.[destino]) return;

            const t = tasasReales[origen][destino];
            const umbral = UMBRALES_FIJO[origen] || 100;
            const usaPref = monto >= umbral;
            const tasaFinal = usaPref ? t.preferencial : t.regular;

            const ganancia = calcularGananciaUSDT(origen, destino, monto, tasaFinal);
            const gananciaPorc = (ganancia.gananciaPorcentaje * 100).toFixed(2);
            const senal = determinarSenal(ganancia.gananciaPorcentaje);

            // Actualizar DOM del simulador
            dom.simTasaFinal.innerText = tasaFinal.toFixed(8);
            dom.simMontoDestino.innerHTML = `${ganancia.montoDestino.toFixed(2)} ${destino}`;
            dom.simUsdtComprados.innerHTML = `${ganancia.usdtComprados.toFixed(2)} USDT`;
            dom.simUsdtVendidos.innerHTML = `${ganancia.usdtVendidos.toFixed(2)} USDT`;
            dom.simGananciaUsdt.innerHTML = `${ganancia.gananciaUSDT.toFixed(2)} USDT`;
            dom.simGananciaPorc.innerHTML = `${gananciaPorc}%`;
            dom.senalBadgeSim.innerHTML = `<span class="signal-badge ${senal.clase}">${senal.texto}</span>`;

            // Precios para el detalle
            const pSell = preciosReales?.[origen]?.sell ?? PRECIOS_FALLBACK[origen]?.sell;
            const pBuy = preciosReales?.[destino]?.buy ?? PRECIOS_FALLBACK[destino]?.buy;
            const pSellStr = pSell ? pSell.toFixed(2) : '?';
            const pBuyStr = pBuy ? pBuy.toFixed(2) : '?';

            dom.simDetalleMargen.innerHTML = `Tasa ${usaPref ? 'preferencial' : 'regular'} ¬∑ Umbral: ${umbral} ${origen} ¬∑ 1 USDT = ${pSellStr} ${origen} (venta) / 1 USDT = ${pBuyStr} ${destino} (compra)`;

            // Alertas
            const gananciaNum = ganancia.gananciaPorcentaje * 100;
            if (gananciaNum < 2) {
                dom.simAlertas.style.display = 'block';
                dom.simAlertas.innerHTML = `<i class="fas fa-exclamation-triangle" style="color: #d32f2f;"></i> <strong>Ganancia muy baja</strong> (${gananciaPorc}%) ¬∑ Riesgo de p√©rdida.`;
                dom.simAlertas.style.background = '#ffebee';
                dom.simAlertas.style.borderLeftColor = '#d32f2f';
            } else if (gananciaNum < 3) {
                dom.simAlertas.style.display = 'block';
                dom.simAlertas.innerHTML = `<i class="fas fa-exclamation-circle"></i> <strong>Ganancia baja</strong> (${gananciaPorc}%) ¬∑ Revisar margen.`;
                dom.simAlertas.style.background = '#fff3e0';
                dom.simAlertas.style.borderLeftColor = '#ff8c42';
            } else {
                dom.simAlertas.style.display = 'none';
            }

            if (ganancia.gananciaUSDT < 0) {
                dom.simAlertas.style.display = 'block';
                dom.simAlertas.innerHTML = `<i class="fas fa-skull-crossbones"></i> <strong>GANANCIA NEGATIVA</strong> ¬∑ P√©rdida de ${Math.abs(ganancia.gananciaUSDT).toFixed(2)} USDT ¬∑ CIRCUIT BREAKER`;
                dom.simAlertas.style.background = '#ffcdd2';
                dom.simAlertas.style.borderLeftColor = '#b71c1c';
            }
        }

        /**
         * Actualiza las m√©tricas del header (hora, spread promedio, llamadas)
         */
        function actualizarMetricas() {
            // Hora actual
            const ahora = new Date();
            const horaStr = ahora.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' });
            const activo = (ahora.getHours() >= 7 && ahora.getHours() < 23) ? 'üü¢' : 'üåô';
            dom.horaMetric.innerHTML = `<i class="fas fa-clock"></i> Hora: ${horaStr} ${activo}`;

            // Spread promedio
            if (preciosReales) {
                let totalSpread = 0, count = 0;
                for (const moneda in preciosReales) {
                    if (preciosReales[moneda].buy && preciosReales[moneda].sell) {
                        const spread = ((preciosReales[moneda].sell - preciosReales[moneda].buy) / preciosReales[moneda].buy) * 100;
                        totalSpread += spread;
                        count++;
                    }
                }
                const spreadAvg = count > 0 ? (totalSpread / count).toFixed(1) : '2.5';
                dom.spreadMetric.innerHTML = `<i class="fas fa-chart-line"></i> Spread √ò: ${spreadAvg}%`;
            }

            // Llamadas (simulado)
            dom.callsMetric.innerHTML = `<i class="fas fa-exchange-alt"></i> Llamadas: 42/80`;
            dom.lastUpdated.innerText = lastUpdated;
        }

        /**
         * Actualiza toda la interfaz
         */
        function actualizarUI() {
            if (!tasasReales) return;
            inicializarSelectRutas();
            renderDashboard();
            renderTabla();
            renderSimulador();
            actualizarMetricas();
        }

        // ----------------------------------------------------------------
        // 6. INICIALIZACI√ìN Y EVENTOS
        // ----------------------------------------------------------------
        window.addEventListener('load', function() {
            // Cargar datos reales; si falla, se activa fallback autom√°ticamente
            cargarDatosReales();

            // Actualizar cada 30 segundos
            setInterval(cargarDatosReales, 30000);

            // Eventos del simulador
            dom.simRuta.addEventListener('change', renderSimulador);
            dom.simMonto.addEventListener('input', renderSimulador);
        });

    </script>
</body>

</html>
